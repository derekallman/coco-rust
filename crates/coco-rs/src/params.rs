use serde::{Deserialize, Serialize};

/// The type of IoU (intersection over union) computation to use.
#[derive(Debug, Clone, Copy, PartialEq, Eq, Deserialize, Serialize)]
pub enum IouType {
    /// Bounding box IoU.
    Bbox,
    /// Segmentation mask IoU (RLE-based).
    Segm,
    /// Keypoint OKS (object keypoint similarity).
    Keypoints,
}

/// Evaluation parameters controlling IoU thresholds, area ranges, and detection limits.
///
/// Defaults match pycocotools: 10 IoU thresholds (0.50:0.05:0.95), 101 recall
/// thresholds, and standard COCO area ranges. Keypoint evaluation uses different
/// defaults (3 area ranges instead of 4, max 20 detections instead of 1/10/100).
#[derive(Debug, Clone)]
pub struct Params {
    /// IoU computation type (bbox, segm, or keypoints).
    pub iou_type: IouType,
    /// Image IDs to evaluate (empty = all images).
    pub img_ids: Vec<u64>,
    /// Category IDs to evaluate (empty = all categories).
    pub cat_ids: Vec<u64>,
    /// IoU thresholds for matching (default: 0.50, 0.55, ..., 0.95).
    pub iou_thrs: Vec<f64>,
    /// Recall thresholds for interpolated precision (default: 0.00, 0.01, ..., 1.00).
    pub rec_thrs: Vec<f64>,
    /// Maximum detections per image for each summary metric (default: [1, 10, 100]).
    pub max_dets: Vec<usize>,
    /// Area ranges as `[min, max]` for filtering (default: all/small/medium/large).
    pub area_rng: Vec<[f64; 2]>,
    /// Labels for each area range (e.g. "all", "small", "medium", "large").
    pub area_rng_lbl: Vec<String>,
    /// Whether to evaluate per-category (true) or pool all categories (false).
    pub use_cats: bool,
    /// Per-keypoint OKS sigmas (default: 17 COCO keypoint sigmas).
    pub kpt_oks_sigmas: Vec<f64>,
}

impl Params {
    /// Create default parameters for the given evaluation type.
    ///
    /// Keypoint evaluation uses 3 area ranges (all/medium/large) and a single
    /// max-detections value of 20. All other types use 4 area ranges
    /// (all/small/medium/large) and max-detections of [1, 10, 100].
    pub fn new(iou_type: IouType) -> Self {
        let (max_dets, area_rng, area_rng_lbl) = match iou_type {
            IouType::Keypoints => (
                vec![20],
                vec![
                    [0.0, 1e10],
                    [32_f64.powi(2), 96_f64.powi(2)],
                    [96_f64.powi(2), 1e10],
                ],
                vec!["all".into(), "medium".into(), "large".into()],
            ),
            _ => (
                vec![1, 10, 100],
                vec![
                    [0.0, 1e10],
                    [0.0, 32_f64.powi(2)],
                    [32_f64.powi(2), 96_f64.powi(2)],
                    [96_f64.powi(2), 1e10],
                ],
                vec![
                    "all".into(),
                    "small".into(),
                    "medium".into(),
                    "large".into(),
                ],
            ),
        };

        // Default OKS sigmas for 17 COCO keypoints
        let kpt_oks_sigmas = vec![
            0.026, 0.025, 0.025, 0.035, 0.035, 0.079, 0.079, 0.072, 0.072, 0.062, 0.062, 0.107,
            0.107, 0.087, 0.087, 0.089, 0.089,
        ];

        let iou_thrs: Vec<f64> = (0..10).map(|i| 0.5 + 0.05 * i as f64).collect();
        let rec_thrs: Vec<f64> = (0..=100).map(|i| i as f64 / 100.0).collect();

        Params {
            iou_type,
            img_ids: Vec::new(),
            cat_ids: Vec::new(),
            iou_thrs,
            rec_thrs,
            max_dets,
            area_rng,
            area_rng_lbl,
            use_cats: true,
            kpt_oks_sigmas,
        }
    }
}
